







[toc]





# 一、一致性hash算法的原理

## 1. 普通hash算法在分布式存储的应用

**分布式缓存如果使用普通hash算法：** 

每台服务器是不同的编号， 通过 hash % 机器数 = 余数 来确定存储在哪台服务器上。

<img src="pic/11-hash%E4%B8%80%E8%87%B4%E6%80%A7%E5%8E%9F%E7%90%86.assets/image-20221102163322229.png" alt="image-20221102163322229" style="zoom: 33%;" />

**普通hash算法的缺陷：**

如果新添加一台服务器， 机器数就会变，再使用原来的算法： hash % 机器数+1 = 余数， 余数就会变化。

此时，之前计算出余数=0， 现在计算出余数=2，当在2号机子上去寻找内容时找不到，因为实际上存储在0号机子上的

<img src="pic/11-hash%E4%B8%80%E8%87%B4%E6%80%A7%E5%8E%9F%E7%90%86.assets/image-20221102163614375.png" alt="image-20221102163614375" style="zoom:33%;" />





## 2. 一致性hash算法原理

**一致性hash算法原理**

有个hash环，将三台服务器都映射到hash环上。

每个图片也通过相同的算法映射在环上，每张图片顺时针向前找到离自己最近的服务器，就存储在对应的服务器上。

<img src="pic/11-hash%E4%B8%80%E8%87%B4%E6%80%A7%E5%8E%9F%E7%90%86.assets/image-20221102164200942.png" alt="image-20221102164200942" style="zoom: 25%;" />



## 3. 一致性hash算法是如何解决缓存失效的

比如下面添加了一台机子D，那么C->D之间的jpg(图中粉色箭头短的)会寻址寻到D服务器上去，但是 D -> C (图中粉色箭头长的)之间的所有图片寻址都是正确的，还是原来的服务器

<img src="pic/11-hash%E4%B8%80%E8%87%B4%E6%80%A7%E5%8E%9F%E7%90%86.assets/image-20221102165037451.png" alt="image-20221102165037451" style="zoom:33%;" />





一致性hash算法优点：

- 当增加服务器，大部分缓存不会失效，不至于所有的压力都跑到后端去（如果在服务器上找不到，就会所有压力去到后端）





## 4. 缓存倾斜解决办法

**缓存倾斜**： 

服务器可能会不均匀的分布在hash环上的一部分，比如下图中的ABC，这样大多数图片都会映射到同一台服务器上（如下图中的A），缓存不均匀导致系统崩溃。

<img src="pic/11-hash%E4%B8%80%E8%87%B4%E6%80%A7%E5%8E%9F%E7%90%86.assets/image-20221102172445060.png" alt="image-20221102172445060" style="zoom: 33%;" />



**缓存倾斜的解决办法：**

当服务器台数变多，就可以均匀地分布在hash环上。

因此增加虚拟节点， 比如A增加：A1， A2， A3，......，B1，B2.... 让虚拟节点均匀的分布在hash环上。

当图片需要存储时，先找到虚拟节点，比如A1， 再通过虚拟节点找到真实节点，最后写在A服务器上。这样所有的图片可以均匀的分布在各个服务器上缓存。





## 5. 如何快速在环上找到存储的节点

有一个图片想要存储，如何快速定位到应该存储的节点？

Answer：

- 二分查找。 将hash环上所有节点的key排序，在这个序列上使用二分查找，快速定位到离自己最近的服务器

# 参考资料

[B站教程](https://www.bilibili.com/video/BV1Hs411j73w)

